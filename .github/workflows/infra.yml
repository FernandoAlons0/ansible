name: Infra Control

on:
  workflow_dispatch:
    inputs:
      minio:
        description: 'minio: up / down'
        required: true
        default: up
        type: choice
        options: [up, down]
      elk:
        description: 'elk: up / down'
        required: true
        default: up
        type: choice
        options: [up, down]
      pg_cluster:
        description: 'pg-cluster: up / down'
        required: true
        default: up
        type: choice
        options: [up, down]

jobs:
  control:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(awk -F= '/^VERSION_CODENAME/{print $2}' /etc/os-release) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Install community.docker collection
        run: ansible-galaxy collection install community.docker

      - name: Управление инфраструктурой
        run: |
          ansible-playbook playbooks/infra.yml \
            -e "minio=${{ inputs.minio }}" \
            -e "elk=${{ inputs.elk }}" \
            -e "pg_cluster=${{ inputs.pg_cluster }}"
